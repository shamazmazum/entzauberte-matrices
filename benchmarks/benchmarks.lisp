(in-package :entzauberte-matrices/benchmarks)

(declaim (inline make-matrix))
(defun make-matrix (m n)
  (make-array (list m n)
              :element-type 'double-float
              :initial-contents
              (loop repeat m collect
                    (loop repeat n collect
                          (random 1d0)))))

(defun conversion ()
  (format t "Conversion 1000x1000 (magicl)~%")
  (let ((m (make-matrix 1000 1000)))
    (tb:with-timing (100)
      (magicl:from-array m (array-dimensions m)))))

(defun mult (n times)
  (format t "Multiplication ~dx~d ⋅ ~dx~d (em)~%" n n n n)
  (let ((m1 (make-matrix n n))
        (m2 (make-matrix n n)))
    (tb:with-timing (times)
      (em:mult m1 m2)))
  (format t "Multiplication ~dx~d ⋅ ~dx~d (magicl)~%" n n n n)
  (let ((m1 (magicl:rand (list n n)))
        (m2 (magicl:rand (list n n))))
    (tb:with-timing (times)
      (magicl:@ m1 m2))))

(defun add (n times)
  (format t "Addition ~dx~d + ~dx~d (em)~%" n n n n)
  (let ((m1 (make-matrix n n))
        (m2 (make-matrix n n)))
    (tb:with-timing (times)
      (em:add m1 m2)))
  (format t "Addition ~dx~d + ~dx~d (magicl)~%" n n n n)
  (let ((m1 (magicl:rand (list n n)))
        (m2 (magicl:rand (list n n))))
    (tb:with-timing (times)
      (magicl:.+ m1 m2))))

(defun det (n times)
  (format t "Determinant ~dx~d (em)~%" n n)
  (let ((m (make-matrix n n)))
    (tb:with-timing (times)
      (em:det m)))
  (format t "Determinant ~dx~d (magicl)~%" n n)
  (let ((m (magicl:rand (list n n))))
    (tb:with-timing (times)
      (magicl:det m))))

(defun inv (n times)
  (format t "Inversion ~dx~d (em)~%" n n)
  (let ((m (make-matrix n n)))
    (tb:with-timing (times)
      (em:invert m)))
  (format t "Inversion ~dx~d (magicl)~%" n n)
  (let ((m (magicl:rand (list n n))))
    (tb:with-timing (times)
      (magicl:inv m))))

(defun eig (n times)
  (format t "Eigenvalues ~dx~d (em)~%" n n)
  (let ((m (make-matrix n n)))
    (tb:with-timing (times)
      (em:eig m)))
  (format t "Eigenvalues ~dx~d (magicl)~%" n n)
  (let ((m (magicl:rand (list n n))))
    (tb:with-timing (times)
      (magicl:eig m))))

(defun svd (n times)
  (format t "SVD ~dx~d (em)~%" n n)
  (let ((m (make-matrix n n)))
    (tb:with-timing (times)
      (em:svd m)))
  (format t "SVD ~dx~d (magicl)~%" n n)
  (let ((m (magicl:rand (list n n))))
    (tb:with-timing (times)
      (magicl:svd m))))

(defun row (n times)
  (format t "row ~dx~d (em)~%" n n)
  (let ((m (make-matrix n n)))
    (tb:with-timing (times)
      (em:row m (random n))))
  (format t "row ~dx~d (magicl)~%" n n)
  (let ((m (magicl:rand (list n n))))
    (tb:with-timing (times)
      (magicl:row m (random n)))))

(defun column (n times)
  (format t "column ~dx~d (em)~%" n n)
  (let ((m (make-matrix n n)))
    (tb:with-timing (times)
      (em:column m (random n))))
  (format t "column ~dx~d (magicl)~%" n n)
  (let ((m (magicl:rand (list n n))))
    (tb:with-timing (times)
      (magicl:column m (random n)))))

(defun reshape (n times)
  (format t "reshape-unsafe ~dx~d (em)~%" n n)
  (let ((m (make-matrix n n)))
    (tb:with-timing (times)
      (em:reshape-unsafe
       (em:reshape-unsafe m (list (expt n 2)))
       (list n n))))
  (format t "reshape ~dx~d (em)~%" n n)
  (let ((m (make-matrix n n)))
    (tb:with-timing (times)
      (em:reshape
       (em:reshape m (list (expt n 2)))
       (list n n))))
  (format t "reshape ~dx~d (magicl)~%" n n)
  (let ((m (magicl:rand (list n n))))
    (tb:with-timing (times)
      (magicl:reshape
       (magicl:reshape m (list (expt n 2)))
       (list n n)))))

(defun vstack (n times)
  (format t "vstack ~dx~d (em)~%" n n)
  (let ((m (make-matrix n n)))
    (tb:with-timing (times)
      (em:vstack (list m m m) 'double-float)))
  (format t "vstack ~dx~d (magicl)~%" n n)
  (let ((m (magicl:rand (list n n))))
    (tb:with-timing (times)
      (magicl:vstack (list m m m)))))

(defun hstack (n times)
  (format t "hstack ~dx~d (em)~%" n n)
  (let ((m (make-matrix n n)))
    (tb:with-timing (times)
      (em:hstack (list m m m) 'double-float)))
  (format t "hstack ~dx~d (magicl)~%" n n)
  (let ((m (magicl:rand (list n n))))
    (tb:with-timing (times)
      (magicl:hstack (list m m m)))))

(defun run-benchmarks ()
  (em:set-num-threads 4)
  (conversion)
  (mult 10   1000000)
  (mult 1000 1000)
  (add 10   1000000)
  (add 1000 1000)
  (det 100 10000)
  (inv 100 10000)
  (eig 10 1000000)
  (eig 1000 50)
  (svd 10 1000000)
  (svd 1000 50)
  (row 10 1000000)
  (row 1000 10000)
  (column 10 1000000)
  (column 1000 10000)
  (reshape 10 1000000)
  (reshape 1000 10000)
  (hstack 10 1000000)
  (hstack 1000 1000)
  (vstack 10 1000000)
  (vstack 1000 1000))
